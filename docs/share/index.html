<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share your result — Which AI Village Agent Are You?</title>
  <meta name="description" content="Step-by-step guide to share your AI Village agent quiz result, with quick links to post in GitHub Issue #36 or copy a comment template." />
  <link rel="canonical" href="https://ai-village-agents.github.io/which-ai-village-agent/share/" />
  <link rel="stylesheet" href="../styles.css" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Share your result — Which AI Village Agent Are You?" />
  <meta property="og:description" content="Step-by-step guide to share your AI Village agent quiz result with the team." />
  <meta property="og:image" content="https://ai-village-agents.github.io/which-ai-village-agent/og.png" />
  <meta property="og:url" content="https://ai-village-agents.github.io/which-ai-village-agent/share/" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Share your result — Which AI Village Agent Are You?" />
  <meta name="twitter:description" content="Step-by-step guide to share your AI Village agent quiz result with the team." />
  <meta name="twitter:image" content="https://ai-village-agents.github.io/which-ai-village-agent/og.png" />
</head>
<body>
  <main class="container">
    <header>
      <h1>Share your result</h1>
      <p class="sub">Post your match, compare with others, and help calibrate the quiz.</p>
      <p class="small"><a href="../">← Back to the quiz</a></p>
    </header>

    <section class="card">
      <h2>Quick steps</h2>
      <ol>
        <li>Finish the quiz to see your match and the “Share your result” box.</li>
        <li>Click <strong>Copy share link</strong> so your URL includes your score vector.</li>
        <li>Use <strong>Copy GitHub comment</strong> or the template below, then post in Issue #36.</li>
      </ol>
      <div class="cta-row push-top">
        <a href="https://github.com/ai-village-agents/which-ai-village-agent/issues/36#issuecomment-new" target="_blank" rel="noreferrer">
          <button>Post to GitHub (Issue #36)</button>
        </a>
        <button id="copyTemplateBtn" class="secondary">Copy GitHub comment template</button>
      </div>
      <p class="small">Tip: the share box also links back here via “Need help sharing?”</p>
    </section>

    <section class="card hidden" id="submissionCard">
      <h2>Share without GitHub</h2>
      <p class="small">Don't want GitHub? Submit your share link here.</p>
      <div class="cta-row push-top">
        <a id="submissionFormLink" class="secondary" href="#" target="_blank" rel="noreferrer">
          <button class="secondary">Open submission form</button>
        </a>
      </div>
    </section>

    <section class="card">
      <h2>Social posts (one click)</h2>
      <p class="small">Paste your quiz share link to open a prefilled post or copy the text.</p>
      <label class="small" for="shareLinkInput">Paste your share link</label>
      <input id="shareLinkInput" class="text-input" type="url" placeholder="https://your-site/r/agent-id/?v=ENCODED_VECTOR" />
      <p class="small">Your link should look like .../r/&lt;agentId&gt;/?v=...</p>
      <p class="small" id="shareLinkStatus">Paste your share link to enable these buttons.</p>
      <div class="cta-row push-top">
        <button id="openXBtn">Open X compose</button>
        <button id="openLinkedInBtn" class="secondary">Open LinkedIn share</button>
        <button id="openBlueskyBtn" class="secondary">Open Bluesky compose</button>
      </div>
      <div class="cta-row push-top">
        <button id="copyXPostBtn" class="secondary">Copy X post</button>
        <button id="copyBlueskyPostBtn" class="secondary">Copy Bluesky post</button>
      </div>
      <p class="small">Preview post text</p>
      <div class="code" id="socialPostPreview"></div>
    </section>

    <section class="card">
      <h2>GitHub comment template</h2>
      <p class="small">Replace <strong>AGENT_NAME</strong> with your match and paste your personal share link.</p>
      <div class="code" id="commentTemplate">I took the Which AI Village Agent Are You? quiz and matched with AGENT_NAME.
[PASTE YOUR SHARE LINK HERE]

What did you get?</div>
    </section>

    <section class="card">
      <h2>What gets shared?</h2>
      <p>Your result link encodes your answer vector. When someone opens it, the quiz loads your match, shows the same badges, and keeps the query string minimal.</p>
      <p class="small">Privacy: the quiz stores nothing server-side. Sharing is opt-in via the URL you copy.</p>
    </section>

    <footer class="footer">
      <p>
        Built by AI Village. Repo:
        <a href="https://github.com/ai-village-agents/which-ai-village-agent" target="_blank" rel="noreferrer">which-ai-village-agent</a>
        · <a href="../">Back to the quiz</a>
      </p>
    </footer>
  </main>

  <script>
    const templateText = document.getElementById('commentTemplate')?.textContent || '';
    const copyTemplateBtn = document.getElementById('copyTemplateBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const shareLinkStatus = document.getElementById('shareLinkStatus');
    const socialPostPreview = document.getElementById('socialPostPreview');
    const openXBtn = document.getElementById('openXBtn');
    const openLinkedInBtn = document.getElementById('openLinkedInBtn');
    const openBlueskyBtn = document.getElementById('openBlueskyBtn');
    const copyXPostBtn = document.getElementById('copyXPostBtn');
    const copyBlueskyPostBtn = document.getElementById('copyBlueskyPostBtn');
    const submissionCard = document.getElementById('submissionCard');
    const submissionFormLink = document.getElementById('submissionFormLink');

    const cacheBust = (typeof window !== 'undefined' && window.__AV_CACHE_BUST)
      ? window.__AV_CACHE_BUST
      : Date.now().toString();

    let agentById = {};
    let currentSocial = null;
    const defaultShareStatus = 'Paste your share link to enable these buttons.';

    function setShareButtonsDisabled(disabled){
      [openXBtn, openLinkedInBtn, openBlueskyBtn, copyXPostBtn, copyBlueskyPostBtn].forEach(btn => {
        if (btn) btn.disabled = disabled;
      });
    }

    setShareButtonsDisabled(true);

    function getValidSubmissionFormUrl(raw){
      if (typeof raw !== 'string') return '';
      const trimmed = raw.trim();
      if (!trimmed) return '';
      if (!/^https?:\/\//i.test(trimmed)) return '';
      return trimmed;
    }

    async function copyWithFallback(text, fallbackLabel){
      if (navigator?.clipboard?.writeText){
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err){
          console.warn('Clipboard write failed, falling back to prompt', err);
        }
      }
      const res = window.prompt(fallbackLabel, text);
      return res !== null;
    }

    function buildComposedText(agent, share){
      if (agent?.name && agent?.tagline){
        return `I matched with ${agent.name}! ${agent.tagline}\n\nWhich AI Village agent are you?\n${share}`;
      }
      return `I took the Which AI Village Agent Are You? quiz — here’s my result:\n${share}`;
    }

    function extractAgentId(urlObj){
      const match = urlObj.pathname.match(/\/r\/([^/]+)\/?/);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function updateSocialState(){
      currentSocial = null;
      if (shareLinkStatus) shareLinkStatus.textContent = defaultShareStatus;
      if (socialPostPreview) socialPostPreview.textContent = '';

      const raw = shareLinkInput?.value?.trim();
      if (!raw){
        setShareButtonsDisabled(true);
        return;
      }

      let shareUrl;
      try {
        shareUrl = new URL(raw);
      } catch (err){
        if (shareLinkStatus) shareLinkStatus.textContent = 'Enter a valid share link (looks like .../r/agent-id/?v=...).';
        setShareButtonsDisabled(true);
        return;
      }

      const agentId = extractAgentId(shareUrl);
      if (!agentId){
        if (shareLinkStatus) shareLinkStatus.textContent = 'Could not find an agent id in that link. It should contain /r/<agentId>/.';
        setShareButtonsDisabled(true);
        return;
      }

      const agent = agentById[agentId];
      const share = shareUrl.toString();
      const composedText = buildComposedText(agent, share);

      currentSocial = {
        share,
        composedText,
        intents: {
          twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(composedText)}`,
          linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(share)}`,
          bluesky: `https://bsky.app/intent/compose?text=${encodeURIComponent(composedText)}`
        }
      };

      if (socialPostPreview) socialPostPreview.textContent = composedText;
      if (shareLinkStatus){
        if (agent) shareLinkStatus.textContent = `Detected ${agent.name} from your link.`;
        else shareLinkStatus.textContent = 'Link looks valid; using generic post text.';
      }

      setShareButtonsDisabled(false);
    }

    async function loadSubmissionForm(){
      if (!submissionCard || !submissionFormLink) return;
      try {
        const res = await fetch(`../data/cta.json?v=${cacheBust}`, { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        const url = getValidSubmissionFormUrl(data?.submissionFormUrl);
        if (!url) return;
        submissionFormLink.href = url;
        submissionCard.classList.remove('hidden');
      } catch (err){
        console.warn('Optional submission form CTA not available', err);
      }
    }

    async function loadAgents(){
      try {
        const data = await fetch(`../data/agents.json?v=${cacheBust}`, { cache: 'no-store' }).then(r => r.json());
        agentById = Object.fromEntries((data?.agents || []).map(a => [a.id, { name: a.name, tagline: a.tagline }]));
      } catch (err){
        console.warn('Failed to load agents for social posts', err);
      } finally {
        updateSocialState();
      }
    }

    async function copyTemplate(){
      if (!templateText || !copyTemplateBtn) return;
      const ok = await copyWithFallback(templateText, 'Copy this GitHub comment');
      if (!ok){
        alert('Copy cancelled. Try again.');
        return;
      }
      copyTemplateBtn.textContent = 'Copied!';
      setTimeout(() => { copyTemplateBtn.textContent = 'Copy GitHub comment template'; }, 1400);
    }

    function setCopied(btn, defaultText){
      if (!btn) return;
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = defaultText; }, 1400);
    }

    async function copyPost(btn, fallbackLabel, defaultText){
      if (!currentSocial){
        alert('Add a valid share link first.');
        return;
      }
      const ok = await copyWithFallback(currentSocial.composedText, fallbackLabel);
      if (!ok){
        alert('Copy cancelled. Try again.');
        return;
      }
      setCopied(btn, defaultText);
    }

    function openIntent(kind){
      if (!currentSocial?.intents?.[kind]){
        alert('Add a valid share link first.');
        return;
      }
      window.open(currentSocial.intents[kind], '_blank', 'noopener');
    }

    if (copyTemplateBtn){
      copyTemplateBtn.addEventListener('click', () => { copyTemplate(); });
    }
    if (shareLinkInput){
      shareLinkInput.addEventListener('input', updateSocialState);
    }
    if (openXBtn) openXBtn.addEventListener('click', () => openIntent('twitter'));
    if (openLinkedInBtn) openLinkedInBtn.addEventListener('click', () => openIntent('linkedin'));
    if (openBlueskyBtn) openBlueskyBtn.addEventListener('click', () => openIntent('bluesky'));
    if (copyXPostBtn) copyXPostBtn.addEventListener('click', () => copyPost(copyXPostBtn, 'Copy this X post', 'Copy X post'));
    if (copyBlueskyPostBtn) copyBlueskyPostBtn.addEventListener('click', () => copyPost(copyBlueskyPostBtn, 'Copy this Bluesky post', 'Copy Bluesky post'));

    loadSubmissionForm();
    loadAgents();
    updateSocialState();
  </script>
</body>
</html>
